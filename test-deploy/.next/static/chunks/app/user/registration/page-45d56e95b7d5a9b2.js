(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[424],{514:(e,t,s)=>{"use strict";s.d(t,{f7:()=>i,gf:()=>r});let n="access_token",l="token_type";function a(){return"undefined"!=typeof localStorage}function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bearer";a()&&(localStorage.setItem(n,e),localStorage.setItem(l,t))}function r(){return a()?{accessToken:localStorage.getItem(n),tokenType:localStorage.getItem(l)}:{accessToken:null,tokenType:null}}},2956:(e,t,s)=>{"use strict";s.d(t,{n:()=>a});var n=s(514);let l=s(7358).env.NEXT_PUBLIC_API_BASE_URL||"http://localhost:8000";async function a(e){var t;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{method:a="GET",body:i,headers:r={},auth:o=!1,signal:c}=s,d={...r};if(i instanceof FormData||(d["Content-Type"]="application/json"),o){let{accessToken:e,tokenType:t}=(0,n.gf)();e&&(d.Authorization="".concat(t||"Bearer"," ").concat(e))}let x=await fetch("".concat(l).concat(e),{method:a,headers:d,body:i instanceof FormData?i:null!=i?JSON.stringify(i):void 0,credentials:"include",signal:c}),u=(null==(t=x.headers.get("content-type"))?void 0:t.includes("application/json"))?await x.json().catch(()=>null):null;if(!x.ok)throw Error((null==u?void 0:u.detail)||(null==u?void 0:u.message)||"Request failed: ".concat(x.status));return u}},3260:(e,t,s)=>{Promise.resolve().then(s.bind(s,3704)),Promise.resolve().then(s.bind(s,3615))},3615:(e,t,s)=>{"use strict";s.d(t,{default:()=>u});var n=s(5155),l=s(2115),a=s(5695),i=s(2956);async function r(){return(0,i.n)("/api/users/departments",{method:"GET"})}async function o(){return(0,i.n)("/api/users/positions",{method:"GET"})}async function c(e){return(0,i.n)("/api/users/register",{method:"POST",body:e})}var d=s(6653),x=s(6766);function u(){let e=(0,a.useRouter)(),[t,s]=(0,l.useState)("input"),[i,u]=(0,l.useState)({last_name:"",first_name:"",extension:"",direct_phone:"",department_id:0,position_id:0,email:"",password:"",password_confirm:""}),[m,p]=(0,l.useState)([]),[h,b]=(0,l.useState)([]),[g,f]=(0,l.useState)(null),[w,j]=(0,l.useState)(""),[y,v]=(0,l.useState)("idle"),[N,_]=(0,l.useState)(null),[k,C]=(0,l.useState)(""),[S,E]=(0,l.useState)(!1),F=(0,l.useCallback)(async()=>{if(g)try{let e=await (0,d.C)(g.user_id);j(e)}catch(e){console.error("QRコード生成エラー:",e)}},[g]);(0,l.useEffect)(()=>{(async()=>{try{console.log("部署・役職データ取得開始...");let[e,t]=await Promise.all([r(),o()]);console.log("部署データ:",e),console.log("役職データ:",t),p(e),b(t)}catch(e){console.error("部署・役職データ取得エラー:",e),console.error("エラー詳細:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0})}})()},[]),(0,l.useEffect)(()=>{(null==g?void 0:g.user_id)&&F()},[g,F]);let A=e=>{let{name:t,value:s}=e.target;u(e=>({...e,[t]:s}))},T=async e=>{if(e.preventDefault(),_(null),i.password!==i.password_confirm)return void _("パスワードが一致しません");if(0===i.department_id)return void _("部署を選択してください");if(0===i.position_id)return void _("役職を選択してください");E(!0);try{let{password_confirm:e,...t}=i,n=await c(t);console.log("登録成功:",n),f(n),s("mfa-setup"),v("idle")}catch(e){console.error("登録エラー:",e),v("error"),_(e instanceof Error?e.message:"登録に失敗しました")}finally{E(!1)}};async function q(){if(g&&6===k.length)try{v("submitting"),await (0,d.V)({user_id:g.user_id,totp_secret:g.totp_secret,backup_codes:g.backup_codes}),s("completion"),v("idle")}catch(e){console.error("MFA設定エラー:",e),_(e instanceof Error?e.message:"MFA設定に失敗しました"),v("idle")}}return"input"===t?(0,n.jsxs)("div",{className:"w-full max-w-md",children:[(0,n.jsx)("h1",{className:"text-center text-xl font-bold text-white mb-12 tracking-[0.25em]",children:"ユーザー 新規登録"}),(0,n.jsxs)("form",{onSubmit:T,className:"space-y-4",children:[(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"last_name",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["姓",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"必須"})]}),(0,n.jsx)("input",{id:"last_name",name:"last_name",type:"text",required:!0,placeholder:"姓を入力してください",value:i.last_name,onChange:A,className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50 placeholder:text-xs placeholder:text-[#999]"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"first_name",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["名",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"必須"})]}),(0,n.jsx)("input",{id:"first_name",name:"first_name",type:"text",required:!0,placeholder:"名を入力してください",value:i.first_name,onChange:A,className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50 placeholder:text-xs placeholder:text-[#999]"})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"extension",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["内線番号",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"任意"})]}),(0,n.jsx)("input",{id:"extension",name:"extension",type:"text",placeholder:"内線番号を入力してください",value:i.extension,onChange:A,className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50 placeholder:text-xs placeholder:text-[#999]"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"direct_phone",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["直通番号",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"任意"})]}),(0,n.jsx)("input",{id:"direct_phone",name:"direct_phone",type:"text",placeholder:"直通番号を入力してください",value:i.direct_phone,onChange:A,className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50 placeholder:text-xs placeholder:text-[#999]"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"department_id",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["部署",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"必須"})]}),(0,n.jsxs)("select",{id:"department_id",name:"department_id",required:!0,value:i.department_id,onChange:e=>u(t=>({...t,department_id:parseInt(e.target.value)})),className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50",children:[(0,n.jsx)("option",{value:0,children:0===m.length?"データ読み込み中...":"部署を選択してください"}),m.map(e=>(0,n.jsxs)("option",{value:e.id,children:[e.name,e.section?" - ".concat(e.section):""]},e.id))]}),0===m.length&&(0,n.jsx)("p",{className:"text-[10px] text-blue-100 bg-blue-500/15 rounded px-2 py-1 mt-1",children:"部署データを読み込み中..."})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"position_id",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["役職",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"必須"})]}),(0,n.jsxs)("select",{id:"position_id",name:"position_id",required:!0,value:i.position_id,onChange:e=>u(t=>({...t,position_id:parseInt(e.target.value)})),className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50",children:[(0,n.jsx)("option",{value:0,children:0===h.length?"データ読み込み中...":"役職を選択してください"}),h.map(e=>(0,n.jsx)("option",{value:e.id,children:e.name},e.id))]}),0===h.length&&(0,n.jsx)("p",{className:"text-[10px] text-blue-100 bg-blue-500/15 rounded px-2 py-1 mt-1",children:"役職データを読み込み中..."})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"email",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["メールアドレス",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"必須"})]}),(0,n.jsx)("input",{id:"email",name:"email",type:"email",autoComplete:"email",required:!0,placeholder:"メールアドレスを入力してください",value:i.email,onChange:A,className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50 placeholder:text-xs placeholder:text-[#999]"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"password",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["パスワード",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"必須"})]}),(0,n.jsx)("input",{id:"password",name:"password",type:"password",autoComplete:"new-password",required:!0,placeholder:"8文字以上で入力してください",value:i.password,onChange:A,className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50 placeholder:text-xs placeholder:text-[#999]"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{htmlFor:"password_confirm",className:"flex items-center gap-1 text-white text-xs font-medium mb-1",children:["パスワード確認",(0,n.jsx)("span",{className:"inline-block rounded bg-[#4aa0e9] px-1 py-0.5 text-[10px] font-bold text-white",children:"必須"})]}),(0,n.jsx)("input",{id:"password_confirm",name:"password_confirm",type:"password",autoComplete:"new-password",required:!0,placeholder:"パスワードを再入力してください",value:i.password_confirm,onChange:A,className:"block w-full rounded-lg bg-white/90 backdrop-blur-sm px-2 py-2 text-[#333] text-sm outline-none border-0 focus:bg-white focus:ring-1 focus:ring-white/50 placeholder:text-xs placeholder:text-[#999]"})]}),N&&(0,n.jsx)("p",{id:"form-error",className:"text-[10px] text-blue-100 bg-blue-500/15 rounded px-2 py-1 text-center",children:N}),"success"===y&&(0,n.jsx)("p",{className:"text-[10px] text-green-100 bg-green-500/15 rounded px-2 py-1 text-center",children:"登録が完了しました。ログインページに遷移します..."}),(0,n.jsx)("div",{className:"pt-6 flex justify-center",children:(0,n.jsxs)("button",{type:"submit",disabled:S,className:"inline-flex items-center justify-center gap-1 rounded-full bg-white/90 backdrop-blur-sm px-4 py-2 text-[#4AA0E9] text-sm font-medium transition-all hover:bg-white hover:shadow-lg disabled:opacity-60","aria-busy":S,children:[S?"送信中…":"登録",(0,n.jsx)("span",{"aria-hidden":!0,className:"inline-block select-none text-base text-[#4AA0E9]",children:"→"})]})}),(0,n.jsx)("div",{className:"text-center",children:(0,n.jsx)("button",{type:"button",onClick:()=>e.push("/login"),className:"text-[10px] text-white/80 hover:text-white underline decoration-white/50 hover:decoration-white transition-colors",children:"既にアカウントをお持ちですか？ログイン"})})]})]}):"mfa-setup"===t&&g?(0,n.jsxs)("div",{className:"w-full max-w-md",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-center mb-6 text-white",children:"二段階認証の設定"}),(0,n.jsxs)("div",{className:"bg-white rounded-lg p-6 space-y-4",children:[(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h3",{className:"font-semibold text-gray-800 mb-2",children:"ステップ1: 認証アプリをインストール"}),(0,n.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:"Google Authenticator、Microsoft Authenticator、またはAuthyをインストールしてください"})]}),(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h3",{className:"font-semibold text-gray-800 mb-2",children:"ステップ2: QRコードをスキャン"}),w?(0,n.jsx)("div",{className:"flex justify-center mb-4",children:(0,n.jsx)(x.default,{src:w,alt:"MFA QR Code",width:192,height:192,className:"w-48 h-48"})}):(0,n.jsx)("div",{className:"bg-gray-100 w-48 h-48 mx-auto flex items-center justify-center text-gray-500",children:"QRコード生成中..."}),(0,n.jsxs)("div",{className:"text-xs text-gray-500 mb-4",children:[(0,n.jsx)("p",{children:"手動入力用の秘密鍵:"}),(0,n.jsx)("code",{className:"bg-gray-100 px-2 py-1 rounded",children:g.totp_secret})]})]}),(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h3",{className:"font-semibold text-gray-800 mb-2",children:"ステップ3: 6桁の認証コードを入力"}),(0,n.jsx)("input",{type:"text",placeholder:"000000",maxLength:6,className:"w-full px-3 py-2 border border-gray-300 rounded-md text-center text-lg tracking-widest",value:k,onChange:e=>C(e.target.value.replace(/\D/g,""))})]}),(0,n.jsx)("button",{onClick:q,disabled:6!==k.length||S,className:"w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50",children:S?"確認中...":"認証コードを確認"}),(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h3",{className:"font-semibold text-gray-800 mb-2",children:"バックアップコード"}),(0,n.jsx)("p",{className:"text-xs text-gray-600 mb-2",children:"認証アプリが使えない場合の緊急用コード:"}),(0,n.jsx)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:g.backup_codes.map((e,t)=>(0,n.jsx)("code",{className:"bg-gray-100 px-2 py-1 rounded text-center",children:e},t))})]})]})]}):"completion"===t?(0,n.jsx)("div",{className:"w-full max-w-md",children:(0,n.jsxs)("div",{className:"bg-white rounded-lg p-8 text-center",children:[(0,n.jsx)("div",{className:"text-green-500 text-6xl mb-4",children:"✅"}),(0,n.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-4",children:"設定完了！"}),(0,n.jsxs)("p",{className:"text-gray-600 mb-6",children:["二段階認証の設定が完了しました。",(0,n.jsx)("br",{}),"アカウントが有効化され、セキュリティが大幅に向上しました。"]}),(0,n.jsx)("button",{onClick:()=>e.push("/login"),className:"bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700",children:"ログイン画面へ"})]})}):null}},3704:(e,t,s)=>{"use strict";s.d(t,{default:()=>a});var n=s(5155),l=s(2115);function a(e){let{scale:t=1,vwRatio:s=.9,maxWidthPx:a=1100}=e,[i,r]=(0,l.useState)({width:0,height:0,top1:0,top2:0,top3:0});(0,l.useEffect)(()=>{let e=()=>{let e=window.innerWidth,n=window.innerHeight,l=Math.min(e*s,a)*t,i=.35917765074963215*l,o=Math.max(0,n-i);r({width:l,height:i,top1:0,top2:0+i,top3:o})};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[a,t,s]);let o={left:"50%",transform:"translateX(-50%)",width:i.width,height:i.height,borderRadius:706.9231};return(0,n.jsxs)("div",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0",children:[(0,n.jsx)("div",{className:"absolute",style:{...o,top:i.top1,background:"linear-gradient(90deg, rgba(135,196,247,0.4) 0%, rgba(160,199,217,0) 79%)"}}),(0,n.jsx)("div",{className:"absolute",style:{...o,top:i.top2,background:"linear-gradient(270deg, rgba(143,184,234,0.4) 0%, rgba(160,199,217,0) 78%)"}}),(0,n.jsx)("div",{className:"absolute",style:{...o,top:i.top3,background:"linear-gradient(90deg, rgba(142,184,216,0.3) 0%, rgba(160,199,217,0) 79%)"}})]})}},6653:(e,t,s)=>{"use strict";s.d(t,{C:()=>a,V:()=>l});var n=s(2956);async function l(e){return(0,n.n)("/api/mfa/setup-complete",{method:"POST",body:e})}async function a(e){return(await (0,n.n)("/api/mfa/generate-qr/".concat(e))).qr_code}}},e=>{var t=t=>e(e.s=t);e.O(0,[212,441,684,358],()=>t(3260)),_N_E=e.O()}]);